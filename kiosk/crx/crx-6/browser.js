(function(){var e=[].indexOf;define(function(require){var t,i,r,s;return t=require("drc_readiness_tests"),i=require("helpers"),r=require("logger"),s=require("underscore"),function(){class o{constructor(){this.messageWbte=this.messageWbte.bind(this),this.backgroundMessageDispatch=this.backgroundMessageDispatch.bind(this),this.wbteMessageDispatch=this.wbteMessageDispatch.bind(this),this.onClearCache=this.onClearCache.bind(this),this.onComputerDetailsRequest=this.onComputerDetailsRequest.bind(this),this.onSaveReadiness=this.onSaveReadiness.bind(this),this.onGetSavedReadiness=this.onGetSavedReadiness.bind(this),this.onSecurityDetails=this.onSecurityDetails.bind(this),this.onAddReadinessTests=this.onAddReadinessTests.bind(this),this.onTestExit=this.onTestExit.bind(this),this.onUpdateConfig=this.onUpdateConfig.bind(this),this._quit=this._quit.bind(this),this._setUrl=this._setUrl.bind(this),this.onChromebookWindowResize=this.onChromebookWindowResize.bind(this),this._adjustWebviewSize=this._adjustWebviewSize.bind(this),this._onBeforeRequest=this._onBeforeRequest.bind(this),this._onBeforeSendHeaders=this._onBeforeSendHeaders.bind(this),this._retryPP=this._retryPP.bind(this),this.handleExit=this.handleExit.bind(this),this.handleLoadCommit=this.handleLoadCommit.bind(this),this.handleLoadStart=this.handleLoadStart.bind(this),this.handleLoadStop=this.handleLoadStop.bind(this),this.handleLoadAbort=this.handleLoadAbort.bind(this),this._onClearLocalStorage=this._onClearLocalStorage.bind(this),this.handleLoadRedirect=this.handleLoadRedirect.bind(this),this.isLoadingFallback=!1,window.logger=this.logger=new r({publish:e=>{var t,i;return e.src="Chromebook",t={event:"LogMessage",payload:e},null!=(i=this.webview)?i.contentWindow.postMessage(t,"*"):void 0}})}setup(){var e,t,i;return this.webview=document.querySelector("webview"),(i=null!=(t=this.webview)&&"function"==typeof t.getUserAgent?t.getUserAgent():void 0)&&"function"==typeof(e=this.webview).setUserAgentOverride&&e.setUserAgentOverride(`${i} DRC-SB/CHROMEBOOK`),this.mapMessageEvents(),this.setupMessaging(),this.webview.addEventListener("loadstart",e=>this.loaded=!1),this.webview.addEventListener("contentload",e=>(this.loaded=!0,this.messageWbte({event:"ChromebookSetup"}))),this.webview.addEventListener("permissionrequest",function(e){return"media"===e.permission?e.request.allow():logger.log("Denied permission",e.permission)}),this._adjustWebviewSize(),this._addWebviewEventHandlers(),this._setupDebuggingAndTesting(),this._disableChromevox(),this._addFrameListeners(),this._addPPModule()}messageWbte(e){return this.webview.contentWindow.postMessage(e,"*"),this._writeTestData(e)}messageBackground(e){var t;return null!=(t=this.port)?t.postMessage(e):void 0}setupMessaging(){return this.port=chrome.runtime.connect({name:"port"}),this.port.onMessage.addListener(this.backgroundMessageDispatch),window.addEventListener("message",this.wbteMessageDispatch)}mapMessageEvents(){return this.backgroundMessageEvents={url:this._setUrl,error:e=>this._showError(e.payload),Logger:e=>this.logger.logs.push(e.payload),ChromebookWindowResize:this.onChromebookWindowResize,ShowRegistration:this.onShowRegistration,PlatformInfoResponse:this.onPlatformInfoResponse,ShowSpinner:this.onShowSpinner},this.wbteMessageEvents={ComputerDetailsRequest:this.onComputerDetailsRequest,SecurityDetails:this.onSecurityDetails,UpdateConfig:this.onUpdateConfig,addReadinessTests:this.onAddReadinessTests,saveReadiness:this.onSaveReadiness,getSavedReadiness:this.onGetSavedReadiness,ClearCache:this.onClearCache,SendLogs:()=>this.logger.sendLogs,TestExit:this.onTestExit,quit:this._quit,ClearLocalStorage:this._onClearLocalStorage}}backgroundMessageDispatch(t){var i,r;return logger.log("message",t),"webview"===t.type&&(i=t.event,e.call(Object.keys(this.backgroundMessageEvents),i)>=0)?(null!=(r=this.backgroundMessageEvents[t.event])&&r.apply(this,arguments),this._writeTestData(t)):"wbte"===t.type?this.messageWbte(t):"pp"===t.type?(t.source="background",this._sendPP(t)):logger.log("Received unknown event",t),!0}wbteMessageDispatch(e){var t,i,r;return(i=null!=(r=e.data)?r.event:void 0)&&(t=this.wbteMessageEvents[i.split(":")[0]])?t(e.data):logger.log("Received Unknown Event",e),!0}onClearCache(){return logger.info("Clearing browser cache"),this.webview.clearData({},{appcache:!0,cookies:!0,fileSystems:!0,indexedDB:!0,localStorage:!0,webSQL:!0},()=>(logger.info("Successfully cleared cache"),this._writeTestData({event:"ClearCache",status:"OK"})))}onComputerDetailsRequest(e){return logger.info(`Sending ${e.event} event to background.`),this.messageBackground(e)}onSaveReadiness(e){return logger.info("saving readiness test"),chrome.storage.local.get("storedReadiness",t=>{var r,s;try{return(s=t.storedReadiness||{})[i.dateString(!0)]=JSON.parse(e.payload),chrome.storage.local.set({storedReadiness:s},()=>(logger.info("readiness saved"),this._writeTestData({event:"saveReadiness",status:"OK"})))}catch(e){return r=e,logger.warn("failed saving readiness",r)}})}onGetSavedReadiness(){return chrome.storage.local.get("storedReadiness",e=>{try{e=JSON.stringify(e.storedReadiness||{})}catch(t){t,e="{}"}return this.messageWbte({event:"getSavedReadiness",payload:e})})}onSecurityDetails(e={}){chrome.power.requestKeepAwake("system");try{e=JSON.parse(e.payload),logger.info("Got security details",e)}catch(e){e,logger.info("Invalid security details")}return this.validUrls=e.validURLPrefix||[],this.validUrls.length>0&&this.validUrls.push("blob:"),this.authorizedHeaderUrls=e.authorizedHeaderPrefix||[],logger.info("Set valid prefix",this.validUrls),this._writeTestData({event:"SecurityDetails",status:"OK"})}onAddReadinessTests(e={}){return new t(e,e=>this.messageWbte(e)).run()}onTestExit(){return chrome.power.releaseKeepAwake(),this._writeTestData({event:"TestExit",status:"OK"})}onUpdateConfig(e){return logger.info(`Sending ${e.event} event to background.`),this.messageBackground(e),this._writeTestData({event:"UpdateConfig",status:"OK"})}_quit(){return window.close()}navigateTo(e){var t;return this._hideError(),null!=(t=this.webview)?t.src=e:void 0}_setUrl(e){var t;return this._showSpinner(!1),this.config={startupUrl:e.payload},this.validUrls=[],this.authorizedHeaderUrls=[],document.querySelector("#location").val=this.config.startupUrl,null!=(t=this.webview)?t.src=this.config.startupUrl:void 0}onChromebookWindowResize(e){return this._adjustWebviewSize(),this.messageWbte({event:"ChromebookWindowResize"})}onPlatformInfoResponse(e){if(null!=(null!=e?e.payload:void 0))return window.computerDetails=e.payload}static _sort(e,t){return e.sort(function(e,i){var r,s,o,n;return(null!=(r=e[t])?r.toLowerCase().trim():void 0)<(null!=(s=i[t])?s.toLowerCase().trim():void 0)?-1:(null!=(o=e[t])?o.toLowerCase().trim():void 0)===(null!=(n=i[t])?n.toLowerCase().trim():void 0)?0:1})}onShowSpinner(e){return this._showSpinner(!0,e.payload||"Loading")}onShowRegistration(e){var t,r,s,n,a,d,l,u,h,c,p,g;for(this._showSpinner(!1),this._hideError(),l=e.payload||{},o._sort((null!=l?l.leas:void 0)||[],"leaName"),null!=(u=document.querySelector("#device-id"))&&(u.innerText=l.deviceId),null!=(h=document.querySelector("#registration-webview"))&&(h.style.visibility="visible"),g=document.querySelector("#select-group"),t=document.querySelector("#cancel-group"),n=document.querySelector("#registration-errors"),p={district:document.querySelector("#district-id"),school:document.querySelector("#school-id"),group:document.querySelector("#group-id")},a=0,d=(c=l.leas||[]).length;a<d;a++)s=c[a],(r=document.createElement("option")).value=s.leaCode,r.text=s.leaName,p.district.appendChild(r);return p.district.onchange=function(){var e;return p.school.innerHTML='<option value="">Loading...</option>',p.group.innerHTML='<option value="">Select an Organizational Unit</option>',g.setAttribute("class","drc-button-black"),e=this.options[this.selectedIndex].value,i.doXHR({method:"GET",url:`https://dtk.drcedirect.com/v2/registrations/registrations/X_CLIENT_CODE/leas/${e}/schools`,headers:{"Content-Type":"application/json"}}).then(t=>{var i,s,n,a;for(o._sort(t,"schoolName"),p.school.innerHTML='<option value="">Select a School</option>',n=[],i=0,s=t.length;i<s;i++)a=t[i],(r=document.createElement("option")).value=a.schoolCode,r.text=a.schoolName,r.setAttribute("data-lea-code",e),n.push(p.school.appendChild(r));return n}).catch(function(e){return p.school.innerHTML='<option value="">Error Loading</option>',p.group.innerHTML='<option value="">Error Loading</option>'})},p.school.onchange=function(){var e,t;return p.group.innerHTML='<option value="">Loading...</option>',g.setAttribute("class","drc-button-black"),t=this.options[this.selectedIndex].value,e=this.options[this.selectedIndex].getAttribute("data-lea-code"),i.doXHR({method:"GET",url:`https://dtk.drcedirect.com/v2/registrations/registrations/X_CLIENT_CODE/leas/${e}/schools/${t}/groups`,headers:{"Content-Type":"application/json"}}).then(e=>{var t,i,s,n;for(o._sort(e,"groupName"),p.group.innerHTML='<option value="">Select an Organizational Unit</option>',n=[],i=0,s=e.length;i<s;i++)t=e[i],(r=document.createElement("option")).value=t.groupId,r.text=t.groupName,n.push(p.group.appendChild(r));return n}).catch(function(e){return p.group.innerHTML='<option value="">Error Loading</option>'})},p.group.onchange=function(){var e,t;return this.options[this.selectedIndex].value,g.setAttribute("class",(null!=(e=this.options[this.selectedIndex])&&null!=(t=e.value)?t.length:void 0)>0?"drc-button-blue":"drc-button-black")},t.onclick=(()=>(p.district.selectedIndex=0,p.school.innerHTML="<option>Select a School</option>",p.group.innerHTML="<option>Select an Organizational Unit</option>",g.setAttribute("class","drc-button-black"))),g.onclick=(()=>{var e,t,r;return(null!=(e=p.group.options[p.group.selectedIndex])&&null!=(t=e.value)?t.length:void 0)>0?(n.innerHTML="",(r={deviceId:l.deviceId,secret:l.secret,groupId:p.group.options[p.group.selectedIndex].value,clientCode:"X_CLIENT_CODE",leaCode:p.district.options[p.district.selectedIndex].value,schoolCode:p.school.options[p.school.selectedIndex].value}).groupId&&r.leaCode&&r.schoolCode?i.doXHR({method:"POST",url:"https://dtk.drcedirect.com/v2/registrations/registrations/assign",headers:{"Content-Type":"application/json"},data:JSON.stringify(r)}).then(e=>{var t;return this.messageBackground({event:"UpdateConfig",payload:e}),null!=(t=document.querySelector("#registration-webview"))?t.style.visibility="hidden":void 0}).catch(function(e){return console.log("unable to join group, show error",e)}):void 0):n.innerHTML="You must select an Organizational Unit to save"})}_hideError(){return document.querySelector("#sad-webview").style.visibility="hidden",document.querySelector("#error-adminmessage").style.visibility="hidden",document.querySelector("#error-network").style.visibility="hidden"}_showError(e){if(this._showSpinner(!1),document.querySelector("#sad-webview").style.visibility="visible",document.querySelector("#error-network").style.visibility=e.networkError?"visible":"hidden",document.querySelector("#error-adminmessage").style.visibility=e.description?"visible":"hidden",document.querySelector("#error-summary").innerText=e.summary||"",document.querySelector("#error-instruction").innerText=e.instruction||"Please raise your hand and wait for help.",document.querySelector("#error-address").innerText=e.url?`While loading: ${e.url}`:"",document.querySelector("#error-description").innerText=e.description||"",e.addNaclError)return document.querySelector("#error-description").innerHTML+=`<br/><b>${this._getPPError()}</b>`}_getPPError(){var e;return(null!=(e=document.querySelector("embed"))?e.lastError:void 0)||`Timed out after ${this.PP_RETRY_COUNT} attempts`}_getErrorInfo(e){switch(e.reason){case"ERR_CONNECTION_REFUSED":return{summary:"Network Error: Connection to Server Refused",url:e.url,networkError:!0};case"ERR_NAME_NOT_RESOLVED":return{summary:"Network Error: Unable to resolve DNS name",url:e.url,networkError:!0};default:return{summary:`Network Error: Code: ${e.reason}`,networkError:!0}}}_adjustWebviewSize(){var e,t,i,r,s,o;return e=document.querySelector("#controls"),t="hidden"===(null!=(i=getComputedStyle(e))?i.visibility:void 0)?0:e.offsetHeight,o=document.documentElement.clientWidth,s=document.documentElement.clientHeight-t,this.webview.style.width=o+"px",this.webview.style.height=s+"px",(r=document.querySelector("#sad-webview")).style.width=o+"px",r.style.height=s+"px"}_onBeforeRequest(e){var t;return(t=!this._isUrlValid(e.url))&&setTimeout(()=>{var e;return null!=(e=this.webview)?e.src=this._getErrorUrl("client_bad_url"):void 0},100),{cancel:t}}_onBeforeSendHeaders(e){return null==e.requestHeaders&&(e.requestHeaders={}),this._shouldAddAuthorizeHeader(e.url)&&null!=s.find(e.requestHeaders,function(e){return"X-DRC-Auth-Token"===e.name})&&e.requestHeaders.push({name:"Authorization",value:window.drcSecret}),{requestHeaders:e.requestHeaders}}_getErrorUrl(e){return`${this.baseUrl}#network-error/${e}`}_isUrlValid(e){var t,i,r,s;if(0===this.validUrls.length)return!0;for(t=0,i=(r=this.validUrls).length;t<i;t++)if(s=r[t],e.substr(0,s.length)===s)return!0;return!1}_shouldAddAuthorizeHeader(e){var t,i,r,s;for(t=0,i=(r=this.authorizedHeaderUrls).length;t<i;t++)if(s=r[t],e.substr(0,s.length)===s)return!0;return!1}_disableChromevox(){var e;return null!=(e=chrome.accessibilityFeatures.spokenFeedback)?e.set({value:!1},function(){}):void 0}_sendPP(e){return this.pp.postMessage(e)}_retryPP(e){var t;return null!=e?logger.error(`PPAPI load crashed: ${this._getPPError()}`):logger.error(`PPAPI load timed out in ${this.PP_WAIT_TIME}ms.`),null!=this.ppTimeout&&clearTimeout(this.ppTimeout),this.ppRetry>this.PP_RETRY_COUNT?this.messageBackground({event:"PPError"}):(this.ppRetry++,null!=(t=this.pp)&&"function"==typeof t.remove&&t.remove(),this._addPPModule())}_addFrameListeners(e,t){var i;if(i=document.getElementById("ppapi"))return i.addEventListener("load",e=>(e.target.postMessage((new Date).getTime().toString()),this._sendPP({command:"secret"})),!0),i.addEventListener("error",this._retryPP,!0),i.addEventListener("crash",this._retryPP,!0)}_addPPModule(){var e;if(e=document.getElementById("ppapi"))return this.pp=document.createElement("embed"),this.pp.addEventListener("message",e=>{var t,i,r;if("background"===(null!=(t=e.data)&&null!=(i=t.payload)?i.source:void 0)&&(logger.info("Sending pp message to background",e.data),this.messageBackground(e.data)),"secret"===(null!=(r=e.data)?r.command:void 0))return null!=this.ppTimeout&&clearTimeout(this.ppTimeout),window.drcSecret=e.data.payload,this.messageBackground({event:"PPLoaded"})},!0),this.pp.setAttribute("name","nacl_module"),this.pp.setAttribute("id","nacl_module"),this.pp.setAttribute("width",10),this.pp.setAttribute("height",10),this.pp.setAttribute("path","ppapi"),this.pp.setAttribute("src","ppapi/ss.nmf"),this.pp.setAttribute("type","application/x-pnacl"),this.ppTimeout=setTimeout(this._retryPP,this.PP_WAIT_TIME),e.appendChild(this.pp),null}_addWebviewEventHandlers(){var e,t,i;for(e=0,t=(i=document.querySelectorAll(".close-app")).length;e<t;e++)i[e].onclick=(()=>this._quit());return this.webview.addEventListener("exit",this.handleExit),this.webview.addEventListener("loadstart",this.handleLoadStart),this.webview.addEventListener("loadstop",this.handleLoadStop),this.webview.addEventListener("loadabort",this.handleLoadAbort),this.webview.addEventListener("loadredirect",this.handleLoadRedirect),this.webview.addEventListener("loadcommit",this.handleLoadCommit),this.webview.request.onBeforeRequest.addListener(this._onBeforeRequest,{urls:["<all_urls>"]},["blocking"]),this.webview.request.onBeforeSendHeaders.addListener(this._onBeforeSendHeaders,{urls:["<all_urls>"]},["blocking","requestHeaders"])}_setupDebuggingAndTesting(){}handleExit(e){return this.webview.src=this.config.startupUrl}handleLoadCommit(e){if(e.isTopLevel)return document.querySelector("#location").value=e.url,document.querySelector("#back").disabled=!this.webview.canGoBack(),document.querySelector("#forward").disabled=!this.webview.canGoForward()}handleLoadStart(e){if(document.body.classList.add("loading"),"about:blank"!==e.url&&this._showSpinner(!0,"Loading Page."),this.isLoading=!0,e.isTopLevel)return document.querySelector("#location").value=e.url}handleLoadStop(e){var t;return this.isLoading=!1,document.body.classList.remove("loading"),"about:blank"!==("function"==typeof(t=this.webview).getAttribute?t.getAttribute("src"):void 0)&&this._showSpinner(!1),this.isLoadingFallback=!1}handleLoadAbort(e){var t,i;return-1!==e.url.indexOf("v2/registrations")&&null!=(null!=(i=window.computerDetails)?i.startupUrl:void 0)?(this.isLoadingFallback=!0,void this.navigateTo(window.computerDetails.startupUrl)):this.isLoadingFallback?void 0:(this.isLoading=!1,document.body.classList.remove("loading"),"about:blank"!==("function"==typeof(t=this.webview).getAttribute?t.getAttribute("src"):void 0)&&this._showSpinner(!1),e.isTopLevel&&this._showError(this._getErrorInfo(e)),!1)}_onClearLocalStorage(){return chrome.storage.local.clear(()=>this._writeTestData({event:"ClearLocalStorage",status:"Complete, local storage has been cleared. Please quit the app."}))}handleLoadRedirect(e){if(this._hideError(),e.isTopLevel)return document.querySelector("#location").value=e.newUrl}_enableControls(){0}_showSpinner(e,t=""){var i;if(i=document.querySelector("#background-spinner"))return i.style.visibility=e?"visible":"hidden",i.querySelector(".spinner-text").innerText=t}_setupTests(){0}_writeTestData(e){}}return o.prototype.isLoading=!1,o.prototype.validUrls=[],o.prototype.authorizedHeaderUrls=[],o.prototype.ppRetry=1,o.prototype.ppTimeout=null,o.prototype.PP_RETRY_COUNT=3,o.prototype.PP_WAIT_TIME=1e4,o}.call(this)})}).call(this);