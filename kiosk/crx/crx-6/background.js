(function(){define(function(require){var e,t,r,n,o;return t=require("./event_bridge"),r=require("helpers"),n=require("logger"),o=require("underscore"),6e4,1e4,/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,e=function(){class e extends Error{constructor({type:e,summary:t,description:r,addNaclError:n}){super(),this.type=e,this.summary=t,this.description=r,this.addNaclError=n}}return e.prototype.name="BackgroundError",e}.call(this),class{constructor(e={}){return this._watchWindowSize=this._watchWindowSize.bind(this),this._getNetworkInterfaces=this._getNetworkInterfaces.bind(this),this._saveConfiguration=this._saveConfiguration.bind(this),this._kioskModeCheck=this._kioskModeCheck.bind(this),this._directToDTKLoader=this._directToDTKLoader.bind(this),this._applyCachedConfig=this._applyCachedConfig.bind(this),this._sendPPError=this._sendPPError.bind(this),this.webviewError=this.webviewError.bind(this),this.launchData=e,this._ppWaiting=this._waitForPP(),this.eventBridge=new t,window.logger=this.logger=new n({handleLog:e=>this.eventBridge.send({type:"webview",event:"Logger",payload:e})}),this.addEventBridgeHandlers(),this}launch(){return this._createBrowser().then(this._watchWindowSize).then(this._getLocation).then(()=>Promise.all([this._getSystemMemory(),this._getNetworkInterfaces(),this._getSignedInDevices()])).then(this._saveConfiguration).then(this._applyCachedConfig).then(this._kioskModeCheck).then(this._checkForUpdates).then(()=>(this.eventBridge.send({type:"webview",event:"ShowSpinner",payload:"Waiting for Application to Finish Loading."}),this._ppWaiting.promise)).then(this._directToDTKLoader).catch(e=>{switch(e.type){case"error":return this.webviewError(e);case"registration":return this.eventBridge.send({type:"webview",event:"ShowRegistration",payload:e});default:return this.webviewError({summary:"An unknown error occured.",description:"Please contact your system administrator."})}}),this}_createBrowser(){return new Promise(function(t,r){try{return chrome.app.window.create("browser.html",{id:"drcChromeApplication",bounds:{width:1024,height:768}},t)}catch(t){return r(new e({type:"error",summary:"Could not create browser window.",description:`${t}`}))}})}_watchWindowSize(e){return new Promise((t,r)=>(e.onBoundsChanged.addListener(e=>this.eventBridge.send({type:"webview",event:"ChromebookWindowResize"})),t()))}_getLocation(){return new Promise(function(e,t){return null!=chrome.location?(chrome.location.watchLocation("chromeBook",{}),chrome.location.onLocationUpdate.addListener(function(t){return logger.log("chrome.location.onLocationUpdate position = ",JSON.stringify(t)),chrome.location.clearWatch("chromeBook"),e(t)}),chrome.location.onLocationError.addListener(function(t){return logger.warn("chrome.location.onLocationUpdate Error = ",t),e()})):e()})}_getSystemMemory(){return new Promise(function(t,r){try{return chrome.system.memory.getInfo(function(e){return t(parseInt(e.capacity/1048576))})}catch(t){return r(new e({type:"error",summary:"Couldn't retrieve system memory.",description:`${t}`}))}})}_getNetworkInterfaces(){return new Promise((e,t)=>{var r;try{return chrome.system.network.getNetworkInterfaces(t=>e(this._getIpAddress(t)))}catch(t){return r=t,logger.warn(`Couldn't get a network address. ${r}`),e("")}})}_getSignedInDevices(){return new Promise(function(e,t){var r,n,o,i;return n=`unknown ${(null!=(o=window.navigator.appVersion.match(/Chrome\/(.*?) /))?o[1]:void 0)||""}`,r={name:"unknown",os:n,chromeVersion:n},null!=(null!=(i=chrome.signedInDevices)?i.get:void 0)?chrome.signedInDevices.get(!0,function(t){return null!=t[0]?e(t[0]):e(r)}):e(r)})}_saveConfiguration([t,r,n]){return new Promise((o,i)=>{var s,a;try{return s="unknown"===n.name?(null!=(a=r.split("."))?a.join("-"):void 0)||"unknown":n.name,window.computerDetails={RAM:t,sb_os:"SecureClientVersion.ChromeOS",installPath:"chrome://extensions",sbOSArchName:"SecureClientVersion.ChromeOS",username:"Kiosk Mode",client_version:chrome.runtime.getManifest().version,ipAddress:r,machineName:s,machine:s,os_description:n.os,os_version:n.chromeVersion},o()}catch(t){return i(new e({type:"error",summary:"Couldn't save configuration to computerDetails",description:`${t}`}))}})}_kioskModeCheck(){return new Promise((t,r)=>this.launchData.isKioskSession?t():(logger.error("User is not in kiosk mode.",window.computerDetails),r(new e({type:"error",summary:"You are not in Kiosk Mode.",description:"Please restart the test in Kiosk Mode."}))))}_getDTKLoaderUrl(e,t,r,n){var o;return"/"===e[e.length-1]&&(e=e.substr(0,e.length-1)),o=r&&n,t.length>0?e+=`/${t.join(",")}`:o&&(e+="/NULL"),o&&(e+=`/${r}/${n}`),e}_sendUrlEvent(e){return this.eventBridge.send({type:"webview",event:"url",payload:e})}_directToDTKLoader(){return new Promise((e,t)=>chrome.storage.local.get(["ouIds","deviceId","secret","toolkitUrl"],t=>chrome.storage.managed.get(r=>{var n,o;return n=(null!=r?r.ouIds:void 0)||(null!=t?t.ouIds:void 0)||[],o=(null!=r?r.toolkitUrl:void 0)||(null!=t?t.toolkitUrl:void 0)||"https://dtk.drcedirect.com/v2/registrations",this._sendUrlEvent(this._getDTKLoaderUrl(o,n,null!=t?t.deviceId:void 0,null!=t?t.secret:void 0)),e()})))}_checkForUpdates(){return new Promise((e,t)=>{try{return logger.info("Checking for Update"),chrome.runtime.requestUpdateCheck(function(t){return e(t)})}catch(t){return t,e("no_update")}})}_getIpAddress(e){var t,r,n,o;return(null!=(t=null!=(r=null!=(n=null!=(o=this._matchInterface(e,"wlan0",32))?o:this._matchInterface(e,"eth0",32))?n:this._matchInterface(e,"wlan0",128))?r:this._matchInterface(e,"eth0",128))?t.address:void 0)||""}_applyCachedConfig(){return new Promise((e,t)=>chrome.storage.local.get(["config"],t=>{var r;return null!=t.config&&(o.extend(window.computerDetails,{LCS_url:(null!=(r=t.config)?r.lcsUrl:void 0)||""},t.config),this.eventBridge.send({type:"webview",event:"PlatformInfoResponse",payload:window.computerDetails})),e()}))}_matchInterface(e,t,r){return o.find(e,function(e){return e.name===t&&e.prefixLength<r})}_sendPPError(){return this._ppWaiting.reject(new e({type:"error",summary:"A plugin failed to load.",description:"Please contact your system administrator.",addNaclError:!0}))}_waitForPP(){var e,t,r,n;return r=t=null,e=new Promise((e,n)=>[r,t]=[e,n]),n=setTimeout(this._sendPPError,6e4),e.then(function(){return clearTimeout(n)}),e.catch(function(){return clearTimeout(n)}),{promise:e,resolve:r,reject:t}}webviewError(e){return this.eventBridge.send({type:"webview",event:"error",payload:e}),logger.error("WebviewError",e)}addEventBridgeHandlers(){return this.eventBridge.onAny(function(e){if(logger.info("port msg",this.event,e,arguments),null==(null!=e?e.event:void 0))return logger.log("No event data",e)}),this.eventBridge.on("PPLoaded",()=>this._ppWaiting.resolve()),this.eventBridge.on("PPError",this._sendPPError),this.eventBridge.on("ComputerDetailsRequest",()=>(logger.info("Sending stored comp details -> wbte",window.computerDetails),this.eventBridge.send({type:"wbte",event:"PlatformInfoResponse",payload:window.computerDetails}))),this.eventBridge.on("UpdateConfig",e=>this.onUpdateConfig(r.parse(e.payload)))}onUpdateConfig(e){var t,r,n;return null==e.config&&(e.config={}),o.extend(window.computerDetails,{LCS_url:(null!=(r=e.config)?r.lcsUrl:void 0)||""},e.config),t=o.pick(e,"ouIds","deviceId","secret","toolkitUrl"),o.extend(t,{config:e.config}),null==e.config.lcsUrl&&null==e.config.LCS_url||(e.config.lcsUrl=e.config.LCS_url=window.computerDetails.lcsUrl),null!=e.contentCache&&(e.config.contentCache=null!=(n=window.computerDetails)?n.contentCache:void 0),chrome.storage.local.set(t,()=>(this.eventBridge.send({type:"webview",event:"PlatformInfoResponse",payload:window.computerDetails}),this.eventBridge.send({type:"wbte",event:"UpdateConfigDone",payload:e.config}))),this}}})}).call(this);